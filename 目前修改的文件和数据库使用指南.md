# 数据库迁移与使用说明

## 已创建的文件

1. **数据库迁移**
   - [console/migrations/m251215_000001_create_message_table.php](console/migrations/m251215_000001_create_message_table.php) - 创建留言表

2. **模型**
   - [common/models/Message.php](common/models/Message.php) - 留言模型（含验证规则、时间戳行为、关联到 User）
   - [common/models/User.php](common/models/User.php) - 扩展了 `getMessages()` 关联方法

3. **控制器**
   - [frontend/controllers/MessageController.php](frontend/controllers/MessageController.php) - 处理留言列表与发布（需登录）

4. **视图**
   - [frontend/views/message/index.php](frontend/views/message/index.php) - 留言列表+发表表单
   - [frontend/views/site/signup.php](frontend/views/site/signup.php) - 注册页已加入验证码
   - [frontend/views/layouts/main.php](frontend/views/layouts/main.php) - 导航已添加「留言板」链接

5. **注册表单**
   - [frontend/models/SignupForm.php](frontend/models/SignupForm.php) - 已添加 `verifyCode` 验证

---

## 数据库配置文件位置

### 🔧 **关键配置文件**

本项目的数据库配置信息存储在以下文件中：

1. **前端和后端通用配置**
   - `common/config/main-local.php` - 主要数据库配置文件

2. **控制台配置**（用于迁移等命令行操作）
   - `console/config/main-local.php` - 需要包含 `components` 下的 `db` 配置

3. **环境模板**（新机器部署时使用）
   - `environments/dev/common/config/main-local.php` - 开发环境模板
   - `environments/prod/common/config/main-local.php` - 生产环境模板

### 📝 **配置示例**

```php
return [
    'components' => [
        'db' => [
            'class' => 'yii\db\Connection',
            'dsn' => 'mysql:host=localhost;dbname=yii2advanced',  // 数据库地址和名称
            'username' => 'root',                                   // 数据库用户名
            'password' => '',                                       // 数据库密码
            'charset' => 'utf8',                                    // 字符集
        ],
    ],
];
```

---

## 在新机器上部署

### ⚠️ **需要重新创建数据库吗？**

**答案：需要，但很简单！** 数据库不会随代码一起迁移，但迁移文件会自动创建表结构。

### 🚀 **新机器部署步骤**

#### 第一步：复制项目文件
将整个项目文件夹复制到新机器的 Web 目录（如 `D:\xampp\htdocs\`）

#### 第二步：启动 MySQL 服务

1. 打开 XAMPP Control Panel
2. 点击 MySQL 旁边的 **Start** 按钮
3. 确保 MySQL 状态显示为绿色的 **Running**

#### 第三步：创建空数据库

访问 `http://localhost/phpmyadmin`，创建名为 `yii2advanced` 的空数据库

#### 第四步：配置数据库连接

编辑以下两个文件，根据新机器的 MySQL 配置修改：

**1. `common/config/main-local.php`**
```php
return [
    'components' => [
        'db' => [
            'class' => 'yii\db\Connection',
            'dsn' => 'mysql:host=localhost;dbname=yii2advanced',  // 修改数据库名
            'username' => 'root',          // 修改用户名（如果不同）
            'password' => '',              // 修改密码（如果有设置）
            'charset' => 'utf8',
        ],
    ],
];
```
   # 第六步：执行数据库迁移（自动创建表）

在项目根目录运行：

```powershell
php yii migrate
```

输入 **yes** 确认。迁移系统会**自动创建**以下表：
- ✅ `user` 表（用户表）
- ✅ `message` 表（留言表）
- ✅ `migration` 表（迁移历史）

⚠️ **重要提示**：迁移只创建**表结构**，不包含**数据内容**！

#### 第七步：导入数据（如果需要保留旧数据）

如果你需要将原机器的数据（如已注册的用户、已发布的留言）也迁移到新机器，需要额外导出导入数据：

**方法：使用 phpMyAdmin（推荐）**

在**原机器**上：
1. 访问 `http://localhost/phpmyadmin`
2. 选择 `yii2advanced` 数据库
3. 点击顶部的「导出」标签
4. 选择「快速」导出方式，格式选择 `SQL`
5. 点击「执行」下载 SQL 文件（如 `yii2advanced.sql`）
（已存放于项目根文件夹）

在**新机器**上（在执行完迁移后）：
1. 访问 `http://localhost/phpmyadmin`
2. 选择 `yii2advanced` 数据库
3. 点击顶部的「导入」标签
4. 选择刚才下载的 SQL 文件
5. 点击「执行」


## 🔄 数据迁移方案对比

| 方案 | 表结构 | 数据内容 | 适用场景 |
|------|--------|----------|----------|
| **仅执行迁移** | ✅ 自动创建 | ❌ 空数据库 | 全新部署，从零开始 |
| **迁移 + 导入SQL** | ✅ 自动创建 | ✅ 完整保留 | 迁移现有项目，保留所有数据 |

---

## 第七步：验证数据库
提示时输入 **0** 选择开发环境（Development），然后输入 **yes** 确认。

### 第四步：执行数据库迁移

在项目根目录运行：

```powershell
php yii migrate
```

系统会提示：

```
Apply the above migration? (yes|no) [no]:
```

输入 **yes** 后按回车，迁移会创建以下表：
- `user` 表（如果还没有）
- `migration` 表（记录迁移历史）
- `message` 表（留言表）

### 第六步：验证数据库

回到 phpMyAdmin (`http://localhost/phpmyadmin`)：
1. 点击左侧的 `yii2advanced` 数据库
2. 查看是否有以下表：
   - `user`
   - `message`
   - `migration`

---

## 功能概览

### 1. **注册功能（含双重验证）**
- 访问：`http://localhost/Internet-Database-Development/frontend/web/index.php?r=site/signup`
- 表单包含：
  - 用户名
  - 邮箱
  - **邮箱验证码**（点击"发送验证码"按钮，系统会发送6位数字验证码到邮箱）
  - 密码（需包含大写字母、小写字母、数字，至少8位）
  - 确认密码
  - 图片验证码
- 注册成功后可直接登录

#### 📧 **邮箱验证码功能**
1. 输入邮箱后点击"发送验证码"按钮
2. 系统会发送6位数字验证码到您的邮箱（有效期10分钟）
3. 查收邮件并输入验证码
4. 验证码正确后才能完成注册


### 2. **登录功能**
- 访问：`http://localhost/Internet-Database-Development/frontend/web/index.php?r=site/login`
- 使用已注册且激活的账号登录

### 3. **留言板**
- 访问：`http://localhost/Internet-Database-Development/frontend/web/index.php?r=message/index`
- **未登录用户**：只能查看留言列表，右侧提示登录/注册
- **已登录用户**：可发表留言，留言会显示作者用户名和时间

### 4. **首页**
- 访问：`http://localhost/Internet-Database-Development/frontend/web/index.php`

---

## 测试步骤

1. **访问首页**
   - 打开浏览器访问：`http://localhost/Internet-Database-Development/frontend/web/index.php`

2. **注册新用户**
   - 点击导航栏的「Signup」
   - 填写：用户名、邮箱、密码、**验证码**
   - 提交后会提示成功

3. **登录**
   - 点击导航栏的「Login」
   - 输入刚注册的用户名和密码
   - 登录成功

4. **发布留言**
   - 点击导航栏的「留言板」
   - 在右侧表单填写内容
   - 点击「发布」按钮
   - 刷新页面即可看到自己的留言

---

## 数据库结构

### `message` 表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键 |
| user_id | INT | 外键，关联 `user.id`（级联删除） |
| content | TEXT | 留言内容 |
| created_at | INT | 创建时间戳 |
| updated_at | INT | 更新时间戳 |

索引：
- `idx-message-user_id` on `user_id`
- `idx-message-created_at` on `created_at`

---
